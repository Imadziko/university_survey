<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>University Workshop Feedback Survey</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lora:wght@600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --color-primary:#7F112F;
      --color-secondary:#00A99D;
      --color-background:#f8faff;
      --color-card-bg:#ffffff;
      --color-text:#1f2937;
      --color-muted:#6b7280;
    }
    html, body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    h1, h2, h3, h4, h5, h6, .font-display { font-family: 'Lora', serif; }
    body{ background:var(--color-background); color:var(--color-text); -webkit-font-smoothing:antialiased; line-height:1.6; min-height:100vh; }
    .shadow-university{ box-shadow:0 10px 15px -3px rgba(0,0,0,.05),0 4px 6px -2px rgba(0,0,0,.05); }
    .text-primary{color:var(--color-primary)} .bg-primary{background-color:var(--color-primary)}
    .hover\:bg-primary-dark:hover{background-color:#5A0D23} .text-secondary{color:var(--color-secondary)}
    .rating-pill{transition:all .2s ease; cursor:pointer;}
    .rating-pill:hover{box-shadow:0 2px 5px rgba(127,17,47,.1); transform:translateY(-1px)}
    .rating-pill.selected{background:var(--color-primary); border-color:var(--color-primary); color:#fff}
    .rating-pill.selected .rating-value{color:#fff}
    .modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:50}
    .modal-content{background:#fff;border-radius:.75rem;padding:1.5rem;max-width:420px;width:90%;box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .success-checkmark{stroke-dasharray:100;stroke-dashoffset:100;animation:drawCheck .5s ease-out .4s forwards}
    @keyframes drawCheck{to{stroke-dashoffset:0}}
    #pauseBanner, #cooldownBanner { display:none; }
    #pauseBanner.active, #cooldownBanner.active { display:flex; }
    .disabled-by-remote { pointer-events:none; opacity:0.5; }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-4xl mx-auto">
    <!-- Logos Row (responsive) -->
    <div class="flex items-center justify-between mb-3">
      <img src="Logo_ETSI_H.png" alt="Escuela T√©cnica Superior de Ingenier√≠a de Sevilla" class="h-10 w-auto md:h-12 lg:h-14 select-none" />
      <img src="US.png" alt="Universidad de Sevilla" class="h-10 w-auto md:h-12 lg:h-14 select-none" />
    </div>

    <!-- Main Header -->
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between border-b-4 border-primary pb-4 mb-4 gap-3">
      <div class="flex items-start md:items-center gap-3 md:gap-4">
        <div>
          <h1 class="text-xl md:text-2xl font-extrabold text-primary font-display leading-tight">
            Department of Mechanical Engineering
          </h1>
          <p class="text-sm text-[var(--color-muted)] leading-tight">
            8th Annual Industrial Management PhD Workshop Evaluation
          </p>
        </div>
      </div>

      <div class="mt-1 md:mt-0 md:text-right">
        <div class="text-2xl md:text-3xl font-extrabold text-secondary font-display">
          <span id="answeredCount">0</span>/<span id="totalCount">4</span>
        </div>
        <div class="text-xs md:text-sm font-semibold text-[var(--color-muted)] uppercase tracking-wider">Questions Answered</div>
      </div>
    </header>

    <!-- Admin PAUSE (global) -->
    <div id="pauseBanner" class="items-center gap-3 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg px-4 py-3 mb-4" role="status" aria-live="polite">
      <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 19.02A2 2 0 003.57 22h16.86a2 2 0 001.75-2.98L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="font-semibold">Voting is currently paused by the administrator.</span>
    </div>

    <!-- Online (Firebase) per-device cooldown -->
    <div id="cooldownBanner" class="items-center gap-3 bg-yellow-50 border border-yellow-300 text-yellow-900 rounded-lg px-4 py-3 mb-4" role="status" aria-live="polite">
      <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M12 3a9 9 0 100 18 9 9 0 000-18z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="font-semibold">Cooldown active ‚Äî wait <span id="cooldownCountdown">30</span>s before voting again.</span>
    </div>

    <main id="mainContent">
      <div id="questionCard" class="bg-[var(--color-card-bg)] p-6 md:p-10 rounded-xl shadow-university"></div>
      <div id="reviewScreen" class="bg-[var(--color-card-bg)] p-6 md:p-10 rounded-xl shadow-university hidden"></div>
      <div id="successScreen" class="hidden">
        <div class="text-center py-16 bg-[var(--color-card-bg)] rounded-xl shadow-university">
          <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-green-500 flex items-center justify-center">
            <svg class="success-checkmark w-10 h-10 text-white" viewBox="0 0 52 52" aria-hidden="true">
              <path d="M14 27l7 7 16-16" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </div>
          <h2 class="text-3xl font-extrabold text-gray-800 mb-2 font-display">Submission Successful!</h2>
          <p class="text-gray-500 max-w-md mx-auto mb-8">Thank you for providing your valuable feedback.</p>
          <button id="restartBtn" class="px-6 py-3 rounded-lg text-sm font-semibold bg-primary text-white hover:bg-primary-dark transition">Start a new response</button>
        </div>
      </div>
    </main>

    <nav id="navigation" class="flex items-center justify-between mt-8 gap-4">
      <button id="backBtn" class="px-6 py-3 rounded-lg text-sm font-semibold border-2 border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition" disabled>‚Üê Previous</button>
      <button id="nextBtn" class="px-6 py-3 rounded-lg text-sm font-semibold bg-primary text-white hover:bg-primary-dark transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next Question ‚Üí</button>
    </nav>
  </div>

  <div id="globalModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalMessage">
    <div class="modal-content">
      <h3 id="modalTitle" class="text-xl font-bold mb-3 text-primary font-display"></h3>
      <p id="modalMessage" class="text-gray-700 mb-4"></p>
      <div class="flex justify-end">
        <button id="modalCloseBtn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold hover:bg-primary-dark transition">Got It</button>
      </div>
    </div>
  </div>

  <form id="gform" method="POST" target="hidden_iframe"
        action="https://docs.google.com/forms/d/e/1FAIpQLSeEw1c93eQdmkDDH1JJjcdn2aC4f0HkTXmyk9edh2Qffd4yKA/formResponse">
    <input type="hidden" name="fvv" value="1">
    <input type="hidden" name="pageHistory" value="0">
  </form>
  <iframe name="hidden_iframe" id="hidden_iframe" title="hidden submit" class="hidden"></iframe>

  <script>
    // --- Client config ---
    const SUBMIT_ON_EACH_ANSWER = true;
    const PARTIAL_SEND_MODE = 'single';

    // Survey model
    const QUESTIONS = [
      { id: 'q1', title: 'How would you rate the clarity and organization of the workshop curriculum?', entry: '564269942' },
      { id: 'q2', title: 'To what extent were the presenters knowledgeable and engaging?',             entry: '1195855513' },
      { id: 'q3', title: 'How relevant were the topics to your current research agenda and professional development?', entry: '235678324' },
      { id: 'q4', title: 'How effectively did the workshop facilitate networking and collaboration opportunities?',   entry: '995359866' }
    ];
    const RATINGS = [
      { value: 5, emoji: 'üåü', label: 'Outstanding (5/5)' },
      { value: 4, emoji: '‚úÖ', label: 'Good (4/5)' },
      { value: 3, emoji: 'üëç', label: 'Satisfactory (3/5)' },
      { value: 2, emoji: '‚ö†Ô∏è', label: 'Needs Improvement (2/5)' },
      { value: 1, emoji: '‚ùå', label: 'Poor (1/5)' }
    ];

    // Local state
    const STORAGE_KEY='universitySurveyAnswers', STATE_KEY='universitySurveyState', VERSION_KEY='universitySurveyVersion';
    const CURRENT_VERSION='v6-firebase-online-cooldown-per-device-logos';
    let current=0, view='question', submitPhase='idle', answers=loadAnswers();

    // Remote state (from Firebase module below)
    window.paused = false;                  // admin pause flag (global)
    window.cooldownUntil = 0;               // per-device cooldown end (ms epoch), from Firebase
    window.cooldownSeconds = 30;            // default; admin can override via survey/cooldownSeconds

    // Persistent deviceId
    (function ensureDeviceId(){
      if(!localStorage.getItem('deviceId')){
        const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('dev-' + Math.random().toString(36).slice(2));
        localStorage.setItem('deviceId', id);
      }
      window.deviceId = localStorage.getItem('deviceId');
    })();

    // DOM refs
    const pauseBanner=document.getElementById('pauseBanner');
    const cooldownBanner=document.getElementById('cooldownBanner');
    const cooldownCountdown=document.getElementById('cooldownCountdown');
    const questionCard=document.getElementById('questionCard');
    const reviewScreen=document.getElementById('reviewScreen');
    const successScreen=document.getElementById('successScreen');
    const navigation=document.getElementById('navigation');
    const backBtn=document.getElementById('backBtn');
    const nextBtn=document.getElementById('nextBtn');
    const answeredCount=document.getElementById('answeredCount');
    const totalCount=document.getElementById('totalCount');
    const globalModal=document.getElementById('globalModal');
    const modalTitle=document.getElementById('modalTitle');
    const modalMessage=document.getElementById('modalMessage');
    const modalCloseBtn=document.getElementById('modalCloseBtn');
    const gform=document.getElementById('gform');
    const hiddenFrame=document.getElementById('hidden_iframe');
    const restartBtn=document.getElementById('restartBtn');

    totalCount.textContent=QUESTIONS.length;

    try{
      const v=localStorage.getItem(VERSION_KEY);
      if(v!==CURRENT_VERSION){
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(STATE_KEY);
        localStorage.setItem(VERSION_KEY,CURRENT_VERSION);
        answers={};
      }
    }catch{}

    restoreState(); updateHeader(); showQuestion(false); updateNav();
    modalCloseBtn.addEventListener('click', ()=>globalModal.classList.add('hidden'));
    globalModal.addEventListener('click',(e)=>{ if(e.target===globalModal) globalModal.classList.add('hidden'); });
    backBtn.addEventListener('click', handleBack);
    nextBtn.addEventListener('click', handleNext);
    hiddenFrame.addEventListener('load', onIframeLoaded);
    restartBtn?.addEventListener('click', resetSurvey);
    window.addEventListener('beforeunload', () => saveState());

    // Cooldown UI tick
    setInterval(()=>{
      const active = isCooldownActive();
      cooldownBanner.classList.toggle('active', active);
      if(active && cooldownCountdown){
        const secs = getCooldownRemainingSeconds();
        cooldownCountdown.textContent = String(secs);
      }
      updateNav();
    }, 500);

    // Helpers
    function isCooldownActive(){ return Date.now() < (window.cooldownUntil || 0); }
    function getCooldownRemainingSeconds(){ return Math.max(0, Math.ceil(((window.cooldownUntil || 0) - Date.now())/1000)); }

    function renderQuestion(){
      const q=QUESTIONS[current], selected=answers[q.id];
      const disabledAll = window.paused || isCooldownActive();
      questionCard.innerHTML=`
        <div class="flex flex-col md:flex-row gap-8 items-start ${disabledAll ? 'disabled-by-remote' : ''}">
          <div class="md:w-1/3 flex-shrink-0">
            <div class="text-6xl font-extrabold text-secondary font-display">${current+1}</div>
            <p class="text-sm font-semibold text-primary mt-2 uppercase tracking-widest">Question ${current+1} of ${QUESTIONS.length}</p>
          </div>
          <div class="md:w-2/3 w-full">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 font-display">${q.title}</h2>
            <div class="flex flex-col space-y-3" role="radiogroup" aria-label="Rating options">
              ${RATINGS.map(r=>`
                <button class="rating-pill p-4 border-2 border-gray-200 rounded-lg flex items-center justify-between bg-white ${selected===r.value?'selected':''}" data-value="${r.value}" ${disabledAll?'disabled':''}>
                  <div class="flex items-center space-x-4"><span class="text-2xl">${r.emoji}</span><span class="text-base font-medium">${r.label}</span></div>
                  <span class="rating-value text-lg font-bold text-[var(--color-muted)]">${r.value}</span>
                </button>
              `).join('')}
            </div>
          </div>
        </div>`;

      if(!disabledAll){
        questionCard.querySelectorAll('.rating-pill').forEach(pill=>pill.addEventListener('click',()=>{
          const v=Number(pill.dataset.value), qinfo=QUESTIONS[current];
          saveAnswer(qinfo.id,v);

          if(SUBMIT_ON_EACH_ANSWER){
            if(PARTIAL_SEND_MODE==='single'){ submitPartial({[qinfo.id]:v}); }
            else {
              const payload={}; QUESTIONS.forEach(q=>{ if(answers[q.id]!==undefined) payload[q.id]=answers[q.id]; });
              submitPartial(payload);
            }
          }

          // Begin (or refresh) this device's cooldown ONLINE
          if (typeof window.triggerPersonalCooldown === 'function') {
            window.triggerPersonalCooldown(window.cooldownSeconds || 30);
          }

          renderQuestion(); updateNav(); saveState();
        }));
      }
    }
    function renderReview(){
      reviewScreen.innerHTML='<div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800 mb-1 font-display">Final Review</h2><p class="text-[var(--color-muted)]">One last look before submitting.</p></div>';
    }
    function showQuestion(save=true){ view='question'; questionCard.classList.remove('hidden'); reviewScreen.classList.add('hidden'); successScreen.classList.add('hidden'); navigation.classList.remove('hidden'); renderQuestion(); if(save) saveState(); }
    function showSuccess(save=true){ view='success'; questionCard.classList.add('hidden'); reviewScreen.classList.add('hidden'); navigation.classList.add('hidden'); successScreen.classList.remove('hidden'); if(save) saveState(); }
    function updateHeader(){ answeredCount.textContent=Object.keys(answers).length; totalCount.textContent=QUESTIONS.length; }
    function updateNav(){
      const disabledAll = window.paused || isCooldownActive();
      const currentAnswer=answers[QUESTIONS[current]?.id];
      const canProceed=currentAnswer!==undefined;
      backBtn.disabled=(current<=0)||disabledAll;
      nextBtn.disabled=!canProceed||disabledAll;
      pauseBanner.classList.toggle('active', window.paused);
      cooldownBanner.classList.toggle('active', isCooldownActive());
    }
    function handleBack(){ if(window.paused || isCooldownActive())return; if(current>0){ current--; renderQuestion(); saveState(); } updateNav(); questionCard.scrollIntoView({behavior:'smooth'}); }
    function handleNext(){ if(window.paused || isCooldownActive())return; if(current<QUESTIONS.length-1){ current++; renderQuestion(); saveState(); updateNav(); } }

    function loadAnswers(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):{}; }catch{ return {}; } }
    function saveAnswer(qid,val){ answers[qid]=val; localStorage.setItem(STORAGE_KEY,JSON.stringify(answers)); updateHeader(); }
    function restoreState(){ try{ const raw=localStorage.getItem(STATE_KEY); if(!raw)return; const st=JSON.parse(raw); if(typeof st.current==='number') current=Math.max(0,Math.min(QUESTIONS.length-1,st.current)); }catch{} }
    function saveState(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify({current})); }catch{} }

    function rebuildFormInputs(payload){
      gform.querySelectorAll("input[name^='entry.']").forEach(n=>n.remove());
      Object.entries(payload).forEach(([qid,val])=>{
        const qinfo=QUESTIONS.find(q=>q.id===qid); if(!qinfo)return;
        const inp=document.createElement('input');
        inp.type='hidden';
        inp.name=`entry.${qinfo.entry}`;
        inp.value=val;
        gform.appendChild(inp);
      });
    }
    function submitPartial(payload){ submitPhase='partial'; rebuildFormInputs(payload); gform.submit(); }
    function onIframeLoaded(){ if(submitPhase==='final'){ submitPhase='idle'; showSuccess(); } }
    function resetSurvey(){ answers={}; localStorage.removeItem(STORAGE_KEY); current=0; showQuestion(); updateHeader(); updateNav(); }
  </script>

  <!-- Firebase: pause + per-device cooldown (ONLINE) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_ebXL2uJpf6fel9k8hdh9l2pcBEdyzGA",
      authDomain: "survey-admin-22481.firebaseapp.com",
      databaseURL: "https://survey-admin-22481-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "survey-admin-22481",
      storageBucket: "survey-admin-22481.firebasestorage.app",
      messagingSenderId: "187430546163",
      appId: "1:187430546163:web:cc67f8714c860e3a396586",
      measurementId: "G-PW6E827Y1X"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // --- Admin PAUSE (existing)
    const pauseRef = ref(db, "survey/pause");
    onValue(pauseRef, snap => {
      window.paused = !!snap.val();
      document.getElementById('pauseBanner').classList.toggle('active', window.paused);
      if (typeof window.renderQuestion === 'function') window.renderQuestion();
      if (typeof window.updateNav === 'function') window.updateNav();
    });

    // --- Optional: admin-defined cooldown seconds (global)
    const cooldownSecondsRef = ref(db, "survey/cooldownSeconds");
    onValue(cooldownSecondsRef, snap => {
      const v = parseInt(snap.val(), 10);
      if (!isNaN(v) && v > 0 && v <= 3600) {
        window.cooldownSeconds = v;
      }
    });

    // --- Per-device online cooldown
    const deviceId = window.deviceId;
    const cooldownRef = ref(db, `survey/cooldowns/${deviceId}`);

    onValue(cooldownRef, snap => {
      const until = parseInt(snap.val(), 10) || 0;
      window.cooldownUntil = until;
      const banner = document.getElementById('cooldownBanner');
      banner.classList.toggle('active', Date.now() < until);
      if (typeof window.renderQuestion === 'function') window.renderQuestion();
      if (typeof window.updateNav === 'function') window.updateNav();
    });

    // Expose a helper that starts (or refreshes) this device's cooldown ONLINE
    window.triggerPersonalCooldown = async function(seconds){
      try{
        const now = Date.now();
        const until = now + (Math.max(1, parseInt(seconds,10)||30) * 1000);
        await set(cooldownRef, until);
      }catch(e){
        console.error('Failed to write cooldown to Firebase:', e);
      }
    };
  </script>
</body>
</html>
