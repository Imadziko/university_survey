<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>University Workshop Feedback Survey</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lora:wght@600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --color-primary:#7F112F;
      --color-secondary:#00A99D;
      --color-background:#f8faff;
      --color-card-bg:#ffffff;
      --color-text:#1f2937;
      --color-muted:#6b7280;
    }
    html, body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    h1, h2, h3, h4, h5, h6, .font-display { font-family: 'Lora', serif; }
    body{ background:var(--color-background); color:var(--color-text); -webkit-font-smoothing:antialiased; line-height:1.6; min-height:100vh; }
    .shadow-university{ box-shadow:0 10px 15px -3px rgba(0,0,0,.05),0 4px 6px -2px rgba(0,0,0,.05); }
    .text-primary{color:var(--color-primary)} .bg-primary{background-color:var(--color-primary)}
    .hover\:bg-primary-dark:hover{background-color:#5A0D23} .text-secondary{color:var(--color-secondary)}
    .rating-pill{transition:all .2s ease; cursor:pointer;}
    .rating-pill:hover{box-shadow:0 2px 5px rgba(127,17,47,.1); transform:translateY(-1px)}
    .rating-pill.selected{background:var(--color-primary); border-color:var(--color-primary); color:#fff}
    .rating-pill.selected .rating-value{color:#fff}
    .modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:50}
    .modal-content{background:#fff;border-radius:.75rem;padding:1.5rem;max-width:420px;width:90%;box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .success-checkmark{stroke-dasharray:100;stroke-dashoffset:100;animation:drawCheck .5s ease-out .4s forwards}
    @keyframes drawCheck{to{stroke-dashoffset:0}}
    #pauseBanner, #cooldownBanner { display:none; }
    #pauseBanner.active, #cooldownBanner.active { display:flex; }
    .disabled-by-remote { pointer-events:none; opacity:0.5; }
    .note { font-size:.9rem; color:#6b7280 }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-4xl mx-auto">
    <!-- Logos -->
    <div class="flex items-center justify-between mb-3">
      <img src="Logo_ETSI_H.png" alt="Escuela T√©cnica Superior de Ingenier√≠a de Sevilla" class="h-10 w-auto md:h-12 lg:h-14 select-none" />
      <img src="US.png" alt="Universidad de Sevilla" class="h-10 w-auto md:h-12 lg:h-14 select-none" />
    </div>

    <!-- Header -->
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between border-b-4 border-primary pb-4 mb-4 gap-3">
      <div>
        <h1 class="text-xl md:text-2xl font-extrabold text-primary font-display leading-tight">
          Department of Mechanical Engineering
        </h1>
        <p class="text-sm text-[var(--color-muted)] leading-tight">
          8th Annual Industrial Management PhD Workshop Evaluation
        </p>
      </div>

      <div class="mt-1 md:mt-0 md:text-right">
        <div class="text-2xl md:text-3xl font-extrabold text-secondary font-display">
          <span id="answeredCount">0</span>/<span id="totalCount">24</span>
        </div>
        <div class="text-xs md:text-sm font-semibold text-[var(--color-muted)] uppercase tracking-wider">Questions Answered</div>
      </div>
    </header>

    <!-- Admin PAUSE -->
    <div id="pauseBanner" class="items-center gap-3 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg px-4 py-3 mb-4" role="status" aria-live="polite">
      <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 19.02A2 2 0 003.57 22h16.86a2 2 0 001.75-2.98L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="font-semibold">Voting is currently paused by the administrator.</span>
    </div>

    <!-- Online cooldown -->
    <div id="cooldownBanner" class="items-center gap-3 bg-yellow-50 border border-yellow-300 text-yellow-900 rounded-lg px-4 py-3 mb-4" role="status" aria-live="polite">
      <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M12 3a9 9 0 100 18 9 9 0 000-18z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="font-semibold">Cooldown active ‚Äî wait <span id="cooldownCountdown">30</span>s before voting again.</span>
    </div>

    <main id="mainContent">
      <div id="questionCard" class="bg-[var(--color-card-bg)] p-6 md:p-10 rounded-xl shadow-university"></div>
      <div id="successScreen" class="hidden">
        <div class="text-center py-16 bg-[var(--color-card-bg)] rounded-xl shadow-university">
          <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-green-500 flex items-center justify-center">
            <svg class="success-checkmark w-10 h-10 text-white" viewBox="0 0 52 52" aria-hidden="true">
              <path d="M14 27l7 7 16-16" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </div>
          <h2 class="text-3xl font-extrabold text-gray-800 mb-2 font-display">All questions are submitted ‚Äî thank you!</h2>
          <p class="text-gray-500 max-w-md mx-auto mb-8">Your feedback has been received.</p>
          <button id="restartBtn" class="px-6 py-3 rounded-lg text-sm font-semibold bg-primary text-white hover:bg-primary-dark transition">Start a new response</button>
        </div>
      </div>
    </main>

    <nav id="navigation" class="flex items-center justify-between mt-8 gap-4">
      <button id="backBtn" class="px-6 py-3 rounded-lg text-sm font-semibold border-2 border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition" disabled>‚Üê Previous</button>
      <button id="nextBtn" class="px-6 py-3 rounded-lg text-sm font-semibold bg-primary text-white hover:bg-primary-dark transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next Question ‚Üí</button>
    </nav>
  </div>

  <!-- Hidden Google Form (action kept from your last version) -->
  <form id="gform" method="POST" target="hidden_iframe"
        action="https://docs.google.com/forms/d/e/1FAIpQLScSLoQMG9evJEKKkMuRDfWV2CXiP-P_fhpsti8QBQ730Z3lCg/formResponse">
    <input type="hidden" name="fvv" value="1">
    <input type="hidden" name="pageHistory" value="0">
  </form>
  <iframe name="hidden_iframe" id="hidden_iframe" title="hidden submit" class="hidden"></iframe>

  <script>
    // --- Client config ---
    const SUBMIT_ON_EACH_ANSWER = true;
    const PARTIAL_SEND_MODE = 'single';

    // 24 questions (wired to Google Form entries)
    const QUESTIONS = [
      { id: 'q1',  title: 'S1.1 Application of a multiscale atomistic model to the study of copper segregation in polycrystalline aluminum structures. Jos√© Manuel Recio L√≥pez', entry: '445127686' },
      { id: 'q2',  title: 'S1.2 Ex vivo characterization of bone regeneration in osteoporotic conditions.', entry: '815225532' },
      { id: 'q3',  title: 'S1.3 Effect of hypoxic senescent secretome on the mechanobiology of lung cancer cells.', entry: '186415273' },
      { id: 'q4',  title: 'S1.4 Tool design and development for the environmental management of human-impacted estuarine systems.', entry: '1296601968' },
      { id: 'q5',  title: 'S1.5* A coupled phase field-gradient plasticity framework for mesh-independent ductile fracture modelling.', entry: '1272906356' },
      { id: 'q6',  title: 'S1.6* Generalized spherical harmonics for orientation averaging and optimal texture design in coupled electro-mechanical polycrystals.', entry: '791501503' },
      { id: 'q7',  title: 'S2.1 Advanced systems in last mile logistics. Jos√© Carlos', entry: '1702535672' },
      { id: 'q8',  title: 'S2.2 Wrinkles to drapes in elastic discs', entry: '2109655394' },
      { id: 'q9',  title: 'S2.3 On the thermomechanical behaviour of polymeric sheets at localized necking.', entry: '944006133' },
      { id: 'q10', title: 'S2.4 On multi site fibre-matrix interface debonding failure prediction under transverse tension using the principle of minimum total energy under a stress condition. Jos√© Miguel', entry: '1148784404' },
      { id: 'q11', title: 'S2.5* Enhancing operational efficiency and reliability in manufacturing and logistics through machine learning: a dual industry study.', entry: '680400674' },
      { id: 'q12', title: 'S2.6* Mechatronic systems and deployable structures for space, defense, and civil applications.', entry: '1640707026' },
      { id: 'q13', title: 'S3.1* Optimal inverter loading ratio for utility-scale photovoltaic plants with battery storage: A techno-economic and regional comparison. Daniel Lugo Laguna', entry: '791526657' },
      { id: 'q14', title: 'S3.2 Fast-ion losses distribution in the ASDEX upgrade first wall. Javier Hidalgo Salaverri', entry: '1610443717' },
      { id: 'q15', title: 'S3.3 Modelado y simulaci√≥n de servicios de urgencias hospitalarias: herramientas para el an√°lisis y mejora del rendimiento en hospitales. Irene Dom√≠nguez Gal√°n', entry: '47333725' },
      { id: 'q16', title: 'S3.4 Heuristics for the green limited-buffer permutation flowshop scheduling problem to minimise makespan.', entry: '1981991075' },
      { id: 'q17', title: 'S3.5* Synthesis, characterization and simulation of UpConversion epoxy‚Äìgraphene nanocomposites.', entry: '143393814' },
      { id: 'q18', title: 'S3.6* Structural topology optimization an the image manifold hypothesis. Ra√∫l Llamas Sand√≠n', entry: '1994457637' },
      { id: 'q19', title: 'S4.1 Axial computed tomography: tool to improve additive manufacturing value chain in the production of aerospace components.', entry: '2111512254' },
      { id: 'q20', title: 'S4.2 Lightweight mechanics for future silicon tracking systems.', entry: '1699690519' },
      { id: 'q21', title: 'S4.3 Development of advanced methodologies for assessing the morphodynamic response of bays and estuaries to extreme events.', entry: '1034266839' },
      { id: 'q22', title: 'S4.4 V-Notch analysis: experimental, analytical, and numerical perspective. Adelaida Mac√≠as Mart√≠nez', entry: '1432915439' },
      { id: 'q23', title: 'S4.5* Role of matrix effects and interfacial integrity on the electromechanical performance of KNN-based piezocomposites.', entry: '77048279' },
      { id: 'q24', title: 'Francisco Javier Ca√±amero Torres ‚Äî S4.6* FEM implementation of the minimization of the total energy subjected to a stress condition to predict delamination.', entry: '702735856' }
    ];

    const RATINGS = [
      { value: 5, emoji: 'üåü', label: 'Outstanding (5/5)' },
      { value: 4, emoji: '‚úÖ', label: 'Good (4/5)' },
      { value: 3, emoji: 'üëç', label: 'Satisfactory (3/5)' },
      { value: 2, emoji: '‚ö†Ô∏è', label: 'Needs Improvement (2/5)' },
      { value: 1, emoji: '‚ùå', label: 'Poor (1/5)' }
    ];

    // Local state
    const STORAGE_KEY='universitySurveyAnswers', STATE_KEY='universitySurveyState', VERSION_KEY='universitySurveyVersion';
    const CURRENT_VERSION='v9-24q-onlinecooldown-locks';
    let current=0, submitPhase='idle', answers=loadAnswers();

    // Remote state from Firebase (set in module below)
    window.paused = false;
    window.cooldownUntil = 0;
    window.cooldownSeconds = 30;
    window.answerLocks = {}; // { qid: { value, ts } }

    // deviceId
    (function ensureDeviceId(){
      if(!localStorage.getItem('deviceId')){
        const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('dev-' + Math.random().toString(36).slice(2));
        localStorage.setItem('deviceId', id);
      }
      window.deviceId = localStorage.getItem('deviceId');
    })();

    // DOM
    const pauseBanner=document.getElementById('pauseBanner');
    const cooldownBanner=document.getElementById('cooldownBanner');
    const cooldownCountdown=document.getElementById('cooldownCountdown');
    const questionCard=document.getElementById('questionCard');
    const successScreen=document.getElementById('successScreen');
    const backBtn=document.getElementById('backBtn');
    const nextBtn=document.getElementById('nextBtn');
    const answeredCount=document.getElementById('answeredCount');
    const totalCount=document.getElementById('totalCount');
    const gform=document.getElementById('gform');
    const hiddenFrame=document.getElementById('hidden_iframe');

    totalCount.textContent=QUESTIONS.length;

    try{
      const v=localStorage.getItem(VERSION_KEY);
      if(v!==CURRENT_VERSION){
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(STATE_KEY);
        localStorage.setItem(VERSION_KEY,CURRENT_VERSION);
        answers={};
      }
    }catch{}

    restoreState(); updateHeader(); showQuestion(false); updateNav();
    backBtn.addEventListener('click', handleBack);
    nextBtn.addEventListener('click', handleNext);
    hiddenFrame.addEventListener('load', onIframeLoaded);
    window.addEventListener('beforeunload', () => saveState());

    // Cooldown UI tick
    setInterval(()=>{
      const active = isCooldownActive();
      cooldownBanner.classList.toggle('active', active);
      if(active && cooldownCountdown){
        const secs = getCooldownRemainingSeconds();
        cooldownCountdown.textContent = String(secs);
      }
      updateNav();
    }, 500);

    // Helpers
    function isCooldownActive(){ return Date.now() < (window.cooldownUntil || 0); }
    function getCooldownRemainingSeconds(){ return Math.max(0, Math.ceil(((window.cooldownUntil || 0) - Date.now())/1000)); }
    function isLocked(qid){ return !!(window.answerLocks && window.answerLocks[qid]); }

    function renderQuestion(){
      const q=QUESTIONS[current];
      const selected = (answers[q.id]!==undefined) ? answers[q.id] : (window.answerLocks[q.id]?.value);
      const locked = isLocked(q.id);
      const disabledAll = window.paused || isCooldownActive() || locked;

      const lockNote = locked
        ? `<p class="note mt-3">You‚Äôve already submitted this question. Please continue to the next question.</p>`
        : '';

      questionCard.innerHTML=`
        <div class="flex flex-col md:flex-row gap-8 items-start ${disabledAll ? 'disabled-by-remote' : ''}">
          <div class="md:w-1/3 flex-shrink-0">
            <div class="text-6xl font-extrabold text-secondary font-display">${current+1}</div>
            <p class="text-sm font-semibold text-primary mt-2 uppercase tracking-widest">Question ${current+1} of ${QUESTIONS.length}</p>
          </div>
          <div class="md:w-2/3 w-full">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 font-display">${q.title}</h2>
            <div class="flex flex-col space-y-3" role="radiogroup" aria-label="Rating options">
              ${RATINGS.map(r=>`
                <button class="rating-pill p-4 border-2 border-gray-200 rounded-lg flex items-center justify-between bg-white ${selected===r.value?'selected':''}" data-value="${r.value}" ${disabledAll?'disabled':''}>
                  <div class="flex items-center space-x-4"><span class="text-2xl">${r.emoji}</span><span class="text-base font-medium">${r.label}</span></div>
                  <span class="rating-value text-lg font-bold text-[var(--color-muted)]">${r.value}</span>
                </button>
              `).join('')}
            </div>
            ${lockNote}
          </div>
        </div>`;

      if(!disabledAll){
        questionCard.querySelectorAll('.rating-pill').forEach(pill=>pill.addEventListener('click',()=>{
          const v=Number(pill.dataset.value), qinfo=QUESTIONS[current];
          saveAnswer(qinfo.id,v);

          // Submit to Google Form
          if(SUBMIT_ON_EACH_ANSWER){
            if(PARTIAL_SEND_MODE==='single'){ submitPartial({[qinfo.id]:v}); }
            else { const payload={}; QUESTIONS.forEach(q=>{ if(answers[q.id]!==undefined) payload[q.id]=answers[q.id]; }); submitPartial(payload); }
          }

          // Lock this question remotely (persists across refresh)
          if (typeof window.lockAnswerRemote === 'function') { window.lockAnswerRemote(qinfo.id, v); }

          // If finished all, show success; else start cooldown for navigation gating
          if(Object.keys(answers).length === QUESTIONS.length){
            showSuccess();
          }else{
            if (typeof window.triggerPersonalCooldown === 'function') {
              window.triggerPersonalCooldown(window.cooldownSeconds || 30);
            }
            renderQuestion(); updateNav(); saveState();
          }
        }));
      }
    }

    function showQuestion(save=true){
      questionCard.classList.remove('hidden');
      successScreen.classList.add('hidden');
      renderQuestion(); if(save) saveState();
    }
    function showSuccess(save=true){
      questionCard.classList.add('hidden');
      successScreen.classList.remove('hidden');
      if(save) saveState();
    }

    function updateHeader(){
      // Count answers using locks + local (locks dominate)
      const lockCount = Object.keys(window.answerLocks || {}).length;
      const localCount = Object.keys(answers || {}).length;
      answeredCount.textContent = Math.max(lockCount, localCount);
      totalCount.textContent = QUESTIONS.length;
    }

    function updateNav(){
      const q=QUESTIONS[current];
      const locked=isLocked(q.id);
      const disabledAll = window.paused || isCooldownActive();
      const hasAnswer = (answers[q.id]!==undefined) || locked;

      backBtn.disabled = (current<=0) || disabledAll;
      // Next is enabled if this question is answered (or locked) and not globally paused/cooldown
      nextBtn.disabled = !hasAnswer || disabledAll;

      pauseBanner.classList.toggle('active', window.paused);
      cooldownBanner.classList.toggle('active', isCooldownActive());
    }

    function handleBack(){ if(window.paused || isCooldownActive())return; if(current>0){ current--; showQuestion(); } }
    function handleNext(){ if(window.paused || isCooldownActive())return; if(current<QUESTIONS.length-1){ current++; showQuestion(); updateNav(); }
      else if((Object.keys(window.answerLocks||{}).length===QUESTIONS.length) || (Object.keys(answers).length===QUESTIONS.length)){ showSuccess(); }
    }

    function loadAnswers(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):{}; }catch{ return {}; } }
    function saveAnswer(qid,val){ answers[qid]=val; try{ localStorage.setItem(STORAGE_KEY,JSON.stringify(answers)); }catch{} updateHeader(); }
    function restoreState(){ try{ const raw=localStorage.getItem(STATE_KEY); if(!raw)return; const st=JSON.parse(raw); if(typeof st.current==='number') current=Math.max(0,Math.min(QUESTIONS.length-1,st.current)); }catch{} }
    function saveState(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify({current})); }catch{} }

    function rebuildFormInputs(payload){
      gform.querySelectorAll("input[name^='entry.']").forEach(n=>n.remove());
      Object.entries(payload).forEach(([qid,val])=>{
        const qinfo=QUESTIONS.find(q=>q.id===qid); if(!qinfo)return;
        const inp=document.createElement('input');
        inp.type='hidden'; inp.name=`entry.${qinfo.entry}`; inp.value=val;
        gform.appendChild(inp);
      });
    }
    function submitPartial(payload){ submitPhase='partial'; rebuildFormInputs(payload); gform.submit(); }
    function onIframeLoaded(){ if(submitPhase==='final'){ submitPhase='idle'; showSuccess(); } }
  </script>

  <!-- Firebase: pause + per-device cooldown + per-question remote locks -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_ebXL2uJpf6fel9k8hdh9l2pcBEdyzGA",
      authDomain: "survey-admin-22481.firebaseapp.com",
      databaseURL: "https://survey-admin-22481-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "survey-admin-22481",
      storageBucket: "survey-admin-22481.firebasestorage.app",
      messagingSenderId: "187430546163",
      appId: "1:187430546163:web:cc67f8714c860e3a396586",
      measurementId: "G-PW6E827Y1X"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Admin pause
    onValue(ref(db, "survey/pause"), snap => {
      window.paused = !!snap.val();
      document.getElementById('pauseBanner').classList.toggle('active', window.paused);
      if (typeof window.renderQuestion === 'function') window.renderQuestion();
      if (typeof window.updateNav === 'function') window.updateNav();
    });

    // Optional global cooldown seconds
    onValue(ref(db, "survey/cooldownSeconds"), snap => {
      const v = parseInt(snap.val(), 10);
      if (!isNaN(v) && v > 0 && v <= 3600) window.cooldownSeconds = v;
    });

    // Per-device cooldown
    const cooldownRef = ref(db, `survey/cooldowns/${window.deviceId}`);
    onValue(cooldownRef, snap => {
      window.cooldownUntil = parseInt(snap.val(), 10) || 0;
      document.getElementById('cooldownBanner').classList.toggle('active', Date.now() < window.cooldownUntil);
      if (typeof window.renderQuestion === 'function') window.renderQuestion();
      if (typeof window.updateNav === 'function') window.updateNav();
    });

    // Per-question locks (persist across refresh)
    const locksRef = ref(db, `survey/answerLocks/${window.deviceId}`);
    onValue(locksRef, snap => {
      window.answerLocks = snap.val() || {};
      // Mirror locks into local answers for header count/UX
      for (const [qid, obj] of Object.entries(window.answerLocks)) {
        if (obj && typeof obj.value !== 'undefined') {
          try {
            const local = JSON.parse(localStorage.getItem('universitySurveyAnswers') || '{}');
            if (local[qid] === undefined) {
              local[qid] = obj.value;
              localStorage.setItem('universitySurveyAnswers', JSON.stringify(local));
            }
          } catch {}
        }
      }
      if (typeof window.updateHeader === 'function') window.updateHeader();
      if (typeof window.renderQuestion === 'function') window.renderQuestion();
      if (typeof window.updateNav === 'function') window.updateNav();
    });

    // Expose helpers
    window.triggerPersonalCooldown = async function(seconds){
      try{
        const now = Date.now();
        const until = now + (Math.max(1, parseInt(seconds,10)||30) * 1000);
        await set(cooldownRef, until);
      }catch(e){ console.error('Cooldown write failed:', e); }
    };

    window.lockAnswerRemote = async function(qid, value){
      try{
        const lockPath = ref(db, `survey/answerLocks/${window.deviceId}/${qid}`);
        await set(lockPath, { value, ts: Date.now() });
      }catch(e){ console.error('Lock write failed:', e); }
    };
  </script>
</body>
</html>
